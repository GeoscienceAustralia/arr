# See comment in ./Makefile.base-vars

# Grouping targets
all: html html-chunk pdf ps
all-html: html html-chunk
install: install-html install-html-chunk install-pdf install-ps

# Build targets
$(VERSION_SOURCE): version
version:
	@if $(SVNVERSION) . > /dev/null; then \
	  echo '<!ENTITY svn.version "'`$(SVNVERSION) .`'">' \
	    > $(VERSION_SOURCE).tmp; \
	  echo '<!ENTITY svn.l10n_revision "$(L10N_REVISION)">' \
	    >> $(VERSION_SOURCE).tmp; \
	else \
	  echo '<!ENTITY svn.version "">' > $(VERSION_SOURCE).tmp; \
	  echo '<!ENTITY svn.l10n_revision "">' > $(VERSION_SOURCE).tmp; \
	fi
	@echo '<!ENTITY svn.date "'`date`'">' >> $(VERSION_SOURCE).tmp
	@if cmp -s $(VERSION_SOURCE) $(VERSION_SOURCE).tmp; then \
	  rm $(VERSION_SOURCE).tmp; \
	else \
	  mv $(VERSION_SOURCE).tmp $(VERSION_SOURCE); \
	fi


# Note to PB: this works but needs to be refined to copy the images over
html: valid $(HTML_TARGET)
$(HTML_TARGET): $(XML_SOURCE) $(VERSION_SOURCE)
	$(XSLTPROC) $(HTML_XSLTPROC_OPTS) --output $(HTML_TARGET) \
	  $(XSL_DIR)/html/docbook.xsl $(XML_SOURCE)

# The trailing slash on the xsltproc --output option is essential to
# output pages into the directory
html-chunk: valid $(HTML_CHUNK_TARGET)
$(HTML_CHUNK_TARGET): $(ALL_SOURCE) $(VERSION_SOURCE) $(STYLESHEET) $(IMAGES)
	mkdir -p $(HTML_CHUNK_DIR)
	$(IFIMAGES) mkdir -p $(HTML_CHUNK_DIR)/images $(ENDIF)
	$(ENSURE_XSL)
	$(XSLTPROC) $(HTML_XSLTPROC_OPTS) \
           --output $(HTML_CHUNK_DIR)/ \
	   $(XSL_DIR)/chunk-stylesheet.xsl $(XML_SOURCE)
	cp $(STYLESHEET) $(HTML_CHUNK_DIR)
	$(IFIMAGES) cp $(IMAGES) $(HTML_CHUNK_DIR)/images $(ENDIF)

html-arch: valid $(HTML_ARCH_TARGET)
$(HTML_ARCH_TARGET): $(HTML_TARGET) $(IMAGES)
	rm -rf $(HTML_ARCH_BASENAME) && \
	$(MAKE) install-html INSTALL_SUBDIR=$(HTML_ARCH_BASENAME) && \
	$(ARCH_CMD) $@ $(HTML_ARCH_BASENAME) && \
	rm -rf $(HTML_ARCH_BASENAME)

html-chunk-arch: valid $(HTML_CHUNK_ARCH_TARGET)
$(HTML_CHUNK_ARCH_TARGET): $(HTML_CHUNK_TARGET) $(IMAGES)
	rm -rf $(HTML_CHUNK_ARCH_BASENAME) && \
	$(MAKE) install-html-chunk \
	  INSTALL_SUBDIR=$(HTML_CHUNK_ARCH_BASENAME) && \
	$(ARCH_CMD) $@ $(HTML_CHUNK_ARCH_BASENAME) && \
	rm -rf $(HTML_CHUNK_ARCH_BASENAME)

fo: $(FO_TARGET)
$(FO_TARGET): $(ALL_SOURCE) $(VERSION_SOURCE) $(IMAGES)
	$(ENSURE_XSL)
	$(XSLTPROC) $(FO_XSLTPROC_OPTS) --output $(FO_TARGET) \
	  $(XSL_DIR)/fo-stylesheet.xsl $(XML_SOURCE)

pdf: $(PDF_TARGET)
$(PDF_TARGET): $(FO_TARGET) $(IMAGES)
	$(TOOLS_DIR)/bin/run-fop.sh -fo $(FO_TARGET) -pdf $(PDF_TARGET)

ps: $(PS_TARGET)
$(PS_TARGET): $(FO_TARGET) $(IMAGES)
	$(TOOLS_DIR)/bin/run-fop.sh -fo $(FO_TARGET) -ps $(PS_TARGET)

# Requires at least docbook-xsl-1.74
epub: $(EPUB_TARGET)
$(EPUB_TARGET): $(UNIFIED_XML_TARGET) $(ALL_SOURCE) 
	$(ENSURE_XSL)
	if [ -x /usr/bin/dbtoepub ] ; then \
	  /usr/bin/dbtoepub -v -o $(EPUB_TARGET) $(UNIFIED_XML_TARGET) ; \
	else \
	  $(TOOLS_DIR)/xsl/epub/bin/dbtoepub -v -o $(EPUB_TARGET) $(UNIFIED_XML_TARGET) ; \
	fi

mobi: $(MOBI_TARGET)
$(MOBI_TARGET): $(EPUB_TARGET)
	if [ -x /usr/bin/ebook-convert ] ; then \
	  /usr/bin/ebook-convert $(EPUB_TARGET) $(MOBI_TARGET) \
            --dont-justify --cover book/images/ebook-cover.jpg -v ; \
	else \
	  $(TOOLS_DIR)/xsl/epub/bin/ebook-convert $(EPUB_TARGET) $(MOBI_TARGET) \
            --dont-justify --cover book/images/ebook-cover.jpg -v ; \
	fi

# Clean targets
clean:
	rm -f $(VERSION_SOURCE) $(HTML_TARGET)
	rm -f $(FO_TARGET) $(PDF_TARGET) $(PS_TARGET) $(EPUB_TARGET) $(MOBI_TARGET)
	rm -rf $(HTML_CHUNK_DIR)

# Utility targets
valid: $(VERSION_SOURCE)
	$(XMLLINT) --relaxng $(DIR_SRC)/docbook/rng/docbookxi.rng --noout --xinclude $(XML_SOURCE)
